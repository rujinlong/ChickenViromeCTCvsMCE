---
title: "13-days-gut-LY"
title-block-banner: true
author:
  - name: Li Yang
date: 2025-09-01
toc: true
toc-depth: 4
number-sections: true
code-fold: true
code-line-numbers: true
code-tools: true
format: 
  html:
    embed-resources: true
    smooth-scroll: true
    page-layout: full
reference-location: section
citation-location: document
params:
  name: "13-days-gut-LY"
---

**Updated: `r format(Sys.time(), '%Y-%m-%d %H:%M:%S', tz = 'CET')` CET.**

This document analyzes the spatiotemporal dynamics of viral communities (vOTUs) in Local Yellow-feather chickens across different gut segments (foregut vs. hindgut) and developmental stages (1-56 days). Non-metric multidimensional scaling (NMDS) ordination is used to visualize community structure and PERMANOVA is applied to test for significant differences.

```{r}
#| label: setup
#| message: false
#| include: false
#| warning: false

wd <- "analyses"
if (basename(getwd()) != wd) {
  setwd(here::here(wd))
}

params <- list(name = "13-days-gut-LY")
here::i_am(paste0(params$name, ".qmd"), uuid = "c94ce298-1afe-466f-b650-cdbc0b261e1c")

projthis::proj_create_dir_target(params$name, clean = FALSE)
path_target <- projthis::proj_path_target(params$name)
path_source <- projthis::proj_path_source(params$name)
path_raw <- path_source("00-raw")
path_resource <- here::here(path_raw, "d00-resource")
path_data <- here::here(path_raw, paste0("d", params$name))

dir.create(path_raw, recursive = TRUE, showWarnings = FALSE)
dir.create(path_data, recursive = TRUE, showWarnings = FALSE)
dir.create(path_resource, recursive = TRUE, showWarnings = FALSE)
```

```{r}
#| label: packages
#| message: false

suppressPackageStartupMessages({
  library(here)
  library(conflicted)
  library(tidyverse)
  library(data.table)
  library(DBI)
  library(RSQLite)
  library(vegan)
  library(ape)
  devtools::load_all()
})

conflicted::conflicts_prefer(dplyr::filter)
conflicted::conflicts_prefer(dplyr::select)
conflicted::conflicts_prefer(dplyr::mutate)
conflicted::conflicts_prefer(dplyr::summarise)
conflicted::conflicts_prefer(dplyr::rename)

con <- load_db()
```

# Load Data

```{r}
#| label: load-data

chicken_contig_annotation <- DBI::dbReadTable(con, "chicken_contig_annotation")
metadata417359 <- read.csv(here::here(path_raw, "417359SraRunTable.csv"))
abundance_contigs_tmm <- read.delim(here::here(path_raw, "abundance_contigs_trimmed_mean.tsv"))
```

# Sample Selection and Metadata Preparation

Filter samples from Local Yellow-feather chickens (Hunan) without feed additives, and classify gut segments into foregut and hindgut.

```{r}
#| label: sample-metadata

map_guts_LY <- metadata417359 %>%
  dplyr::filter(feed_addictive_.growth_promoter == "None") %>%
  dplyr::filter(geo_loc_name == "China:Hunan") %>%
  dplyr::select(Run, Sample.Name, isolation_source, Host_Age)

map_guts_LY2 <- map_guts_LY %>%
  dplyr::mutate(
    isolation_source = dplyr::case_when(
      isolation_source %in% c("duodenum", "jejunum", "ileum") ~ "Foregut",
      isolation_source %in% c("cecum", "colorectum") ~ "Hindgut",
      TRUE ~ isolation_source
    )
  )

cat("Total samples:", nrow(map_guts_LY2), "\n")
cat("Foregut samples:", sum(map_guts_LY2$isolation_source == "Foregut"), "\n")
cat("Hindgut samples:", sum(map_guts_LY2$isolation_source == "Hindgut"), "\n")
```

# Viral Contig Selection

Extract medium-to-high quality viral contigs (checkv_quality_score < 4) from selected samples.

```{r}
#| label: viral-contigs

guts_contig_annotation <- chicken_contig_annotation %>%
  dplyr::filter(contig_id == contig_repid) %>%
  dplyr::filter(study_id %in% map_guts_LY2$Run)

guts_ctg <- guts_contig_annotation %>%
  dplyr::filter(checkv_quality_score < 4) %>%
  dplyr::select(contig_repid, vc_id, vOTU_id)

cat("Total viral contigs:", nrow(guts_ctg), "\n")
cat("Unique vOTUs:", length(unique(guts_ctg$vOTU_id)), "\n")
```

# Abundance Matrix Preparation

## Filter and Aggregate by vOTU

Process TMM-normalized abundance data and aggregate contig-level abundances to vOTU level.

```{r}
#| label: abundance-processing

guts_abundance <- abundance_contigs_tmm %>%
  dplyr::filter(Contig %in% guts_ctg$contig_repid)

votu_raw <- guts_abundance

# Map contigs to vOTUs
map_votu <- chicken_contig_annotation %>%
  dplyr::filter(contig_repid %in% guts_ctg$contig_repid) %>%
  dplyr::select(contig_repid, vOTU_id)

# Aggregate abundances by vOTU
votu_table <- merge(votu_raw, map_votu, by.x = "Contig", by.y = "contig_repid") %>%
  dplyr::group_by(vOTU_id) %>%
  dplyr::summarize(dplyr::across(-c(Contig), sum), .groups = "drop") %>%
  as.data.frame()

# Set vOTU as rownames
rownames(votu_table) <- votu_table$vOTU_id
votu_table <- votu_table %>%
  dplyr::select(-vOTU_id)

cat("vOTU abundance matrix dimensions:", dim(votu_table), "\n")
```

## Quality Control and Data Cleaning

Transpose abundance matrix, filter samples, and remove empty rows and samples with NA values.

```{r}
#| label: data-cleaning

# Transpose table (samples as rows, vOTUs as columns)
ho_raw <- t(votu_table)
ho_raw <- as.data.frame(ho_raw) %>%
  tibble::rownames_to_column(var = "rownames") %>%
  dplyr::filter(rownames %in% map_guts_LY2$Run) %>%
  tibble::column_to_rownames(var = "rownames")

# Check and remove empty rows
row_sums <- rowSums(ho_raw)
empty_rows <- which(row_sums == 0)

if (length(empty_rows) > 0) {
  cat("Empty rows found in samples:", rownames(ho_raw)[empty_rows], "\n")
  ho_raw <- ho_raw[row_sums > 0, ]
}

# Hellinger transformation
data_hell <- vegan::decostand(ho_raw, method = "hellinger")

# Calculate Bray-Curtis distance
dist_matrix <- vegan::vegdist(data_hell, method = "bray")
dist_mat <- as.matrix(dist_matrix)

# Find and remove samples with NA values
na_positions <- which(is.na(dist_mat), arr.ind = TRUE)

if (nrow(na_positions) > 0) {
  rows_with_na <- unique(na_positions[, 1])
  cols_with_na <- unique(na_positions[, 2])
  
  samples_to_remove <- unique(c(
    rownames(dist_mat)[rows_with_na],
    colnames(dist_mat)[cols_with_na]
  ))
  
  cat("Samples to remove due to NA values:", samples_to_remove, "\n")
  
  ho_raw_clean <- ho_raw[!rownames(ho_raw) %in% samples_to_remove, ]
  data_hell_clean <- data_hell[!rownames(data_hell) %in% samples_to_remove, ]
} else {
  cat("No NA values found\n")
  ho_raw_clean <- ho_raw
  data_hell_clean <- data_hell
}

cat("Final sample count:", nrow(ho_raw_clean), "\n")
```

# NMDS Ordination

## Data Preparation

Merge cleaned abundance data with metadata for ordination analysis.

```{r}
#| label: nmds-input

input_raw <- cbind(rowname = rownames(ho_raw_clean), ho_raw_clean)

mapping <- map_guts_LY2 %>%
  dplyr::select(-Sample.Name)

NMDS_input <- merge(input_raw, mapping, by.x = "rowname", by.y = "Run")

cat("NMDS input dimensions:", dim(NMDS_input), "\n")
```

## Run NMDS

Perform NMDS ordination using Bray-Curtis dissimilarity on Hellinger-transformed data.

```{r}
#| label: nmds-calculation

# Hellinger transformation
data <- ho_raw_clean
data_hell <- vegan::decostand(data, method = "hellinger")

# Calculate Bray-Curtis distance
dist_matrix <- vegan::vegdist(data_hell, method = "bray")

# Run NMDS
nmds_result <- vegan::metaMDS(dist_matrix, k = 2, try = 100)

cat("NMDS stress:", nmds_result$stress, "\n")

# Extract sample coordinates and merge with metadata
metadata <- NMDS_input
scores <- as.data.frame(vegan::scores(nmds_result, display = "sites"))
scores$Host_Age <- metadata$Host_Age
scores$isolation_source <- metadata$isolation_source
```

## NMDS Plot: Gut Segment Ellipses

Visualize NMDS ordination with confidence ellipses grouped by gut segment.

```{r}
#| label: fig-nmds-gut
#| fig-cap: "NMDS ordination of viral communities grouped by gut segment"

scores$Host_Age <- factor(scores$Host_Age, levels = c("1-day", "7-day", "14-day", "28-day", "42-day", "56-day"))

plot_NMDS1 <- ggplot2::ggplot(scores, ggplot2::aes(x = NMDS1, y = NMDS2, color = Host_Age, shape = isolation_source)) + 
  ggplot2::geom_point(size = 4) + 
  ggplot2::stat_ellipse(ggplot2::aes(group = isolation_source, color = isolation_source), level = 0.95, linewidth = 0.8, linetype = "dashed") + 
  ggplot2::theme_bw() + 
  ggplot2::labs(
    title = "NMDS Ordination by Gut Segment",
    x = "NMDS Axis 1",
    y = "NMDS Axis 2",
    color = "Host Age",
    shape = "Gut Segment"
  ) + 
  ggplot2::scale_shape_manual(values = c(16, 2, 15, 17)) + 
  ggplot2::scale_color_manual(values = c("#F8766D", "orange", "#E76BF3", "#00BF7D", "#00B0F6", "#103D80", "red", "black")) + 
  ggplot2::theme(
    axis.text = ggplot2::element_text(color = "black"),
    axis.title = ggplot2::element_text(color = "black", face = "bold"),
    plot.title = ggplot2::element_text(hjust = 0.5)
  )

print(plot_NMDS1)

ggplot2::ggsave(path_target("plot_NMDS1.pdf"), plot = plot_NMDS1, width = 8, height = 5)
ggplot2::ggsave(path_target("plot_NMDS1.png"), plot = plot_NMDS1, width = 8, height = 5)
```

### PERMANOVA: Gut Segment and Age Effects

Test for significant differences in viral community composition by gut segment and host age.

```{r}
#| label: permanova-gut

p_table <- as.data.frame(ho_raw_clean)
p_table <- p_table %>%
  tibble::rownames_to_column(var = "Run") %>%
  merge(mapping, by = "Run") %>%
  tibble::column_to_rownames(var = "Run")

p_table$Host_Age <- as.factor(p_table$Host_Age)
p_table$isolation_source <- as.factor(p_table$isolation_source)

adonis_result <- vegan::adonis2(
  dist_matrix ~ isolation_source + Host_Age,
  data = p_table,
  permutations = 999,
  by = "margin"
)

print(adonis_result)
```

## NMDS Plot: Host Age Ellipses

Visualize NMDS ordination with confidence ellipses grouped by host age.

```{r}
#| label: fig-nmds-age
#| fig-cap: "NMDS ordination of viral communities grouped by host age"

scores$Host_Age <- factor(scores$Host_Age, levels = c("1-day", "7-day", "14-day", "28-day", "42-day", "56-day"))

plot_NMDS2 <- ggplot2::ggplot(scores, ggplot2::aes(x = NMDS1, y = NMDS2, color = Host_Age, shape = isolation_source)) + 
  ggplot2::geom_point(size = 4) + 
  ggplot2::stat_ellipse(ggplot2::aes(group = Host_Age, color = Host_Age), level = 0.95, linewidth = 0.8, linetype = "dashed") + 
  ggplot2::theme_bw() + 
  ggplot2::labs(
    title = "NMDS Ordination by Host Age",
    x = "NMDS Axis 1",
    y = "NMDS Axis 2",
    color = "Host Age",
    shape = "Gut Segment"
  ) + 
  ggplot2::scale_shape_manual(values = c(16, 2, 15, 17)) + 
  ggplot2::scale_color_manual(values = c("#F8766D", "orange", "#E76BF3", "#00BF7D", "#00B0F6", "#103D80")) + 
  ggplot2::theme(
    axis.text = ggplot2::element_text(color = "black"),
    axis.title = ggplot2::element_text(color = "black", face = "bold"),
    plot.title = ggplot2::element_text(hjust = 0.5)
  )

print(plot_NMDS2)

ggplot2::ggsave(path_target("plot_NMDS2.pdf"), plot = plot_NMDS2, width = 8, height = 5)
ggplot2::ggsave(path_target("plot_NMDS2.png"), plot = plot_NMDS2, width = 8, height = 5)
```

# Output Files

Files written to the target directory, `r paste0("data/", params$name)`:

```{r}
#| label: list-files-target

projthis::proj_dir_info(path_target(), tz = "CET")
```